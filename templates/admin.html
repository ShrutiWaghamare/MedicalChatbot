<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Medical Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        .admin-page { padding: 80px 24px 48px; max-width: 1200px; margin: 0 auto; }
        .admin-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 32px; }
        .admin-header h1 { font-size: 1.75rem; margin: 0; display: flex; align-items: center; gap: 12px; }
        .admin-header h1 i { color: var(--primary); }
        .admin-nav { display: flex; align-items: center; gap: 12px; }
        .admin-nav a { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .admin-nav a:hover { background: var(--surface-hover); border-color: var(--primary); color: var(--primary-light); }
        .admin-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 32px; box-shadow: var(--shadow-md); }
        .admin-card h2 { font-size: 1.125rem; margin: 0 0 16px 0; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
        .admin-card h2 i { color: var(--primary); }
        .admin-card .meta { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 16px; }
        .admin-table-wrapper { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .admin-table th, .admin-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .admin-table th { background: var(--surface-elevated); font-weight: 600; color: var(--text-secondary); }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table tr:hover td { background: var(--surface-hover); }
        .admin-table .session-id { font-family: ui-monospace, monospace; font-size: 0.8125rem; color: var(--text-muted); max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
        .admin-table .reaction-like { color: var(--secondary); }
        .admin-table .reaction-dislike { color: var(--destructive); }
        .admin-table .user-agent { max-width: 280px; overflow: hidden; text-overflow: ellipsis; font-size: 0.8125rem; color: var(--text-secondary); }
        .admin-table .date { white-space: nowrap; color: var(--text-muted); font-size: 0.8125rem; }
        .admin-table .message-preview { max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.8125rem; color: var(--text-secondary); }
        .admin-table .message-preview[title] { cursor: help; }
        .admin-url-note { font-size: 0.8125rem; color: var(--text-muted); margin-top: 8px; }
        .admin-url-note a { color: var(--primary-light); }
        .admin-loading { text-align: center; padding: 24px; color: var(--text-muted); }
        .admin-error { padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); color: var(--destructive); font-size: 0.875rem; margin-top: 8px; }
        .admin-refresh { margin-left: auto; }
        .btn-refresh { padding: 6px 12px; font-size: 0.8125rem; background: var(--surface-elevated); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-secondary); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-refresh:hover { background: var(--surface-hover); color: var(--text-primary); }
        .admin-stats { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 24px; }
        .admin-stat { background: var(--surface-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px 20px; min-width: 140px; }
        .admin-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-light); font-family: 'Space Grotesk', sans-serif; }
        .admin-stat-label { font-size: 0.8125rem; color: var(--text-muted); margin-top: 4px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
                <i class="fas fa-stethoscope"></i>
                <span>Medical Chatbot Admin</span>
            </div>
            <div class="navbar-links">
                <a href="{{ url_for('index') }}" class="nav-link" title="Back to Chat">
                    <i class="fas fa-comments"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="admin-page">
        <div class="admin-header">
            <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
            <div class="admin-nav">
                <a href="{{ url_for('index') }}"><i class="fas fa-arrow-left"></i> Back to Chat</a>
            </div>
        </div>
        <p class="admin-url-note">When deployed, open <a href="{{ request.url }}">{{ request.url }}</a> to access admin (bookmark this page).</p>

        <div class="admin-stats">
            <div class="admin-stat">
                <div class="admin-stat-value" id="statTotalVisits">{{ visit_counts.total_visits | default(0) }}</div>
                <div class="admin-stat-label">Total page loads</div>
            </div>
            <div class="admin-stat">
                <div class="admin-stat-value" id="statUniqueVisitors">{{ visit_counts.unique_visitors | default(0) }}</div>
                <div class="admin-stat-label">Unique visitors</div>
            </div>
        </div>

        <div class="admin-card">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <h2><i class="fas fa-users"></i> Recent Visits</h2>
                <button type="button" class="btn-refresh" id="refreshVisits" aria-label="Refresh visits"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            <p class="meta">Page loads (who opened the chatbot).</p>
            <div id="visitsLoading" class="admin-loading">Loading visits‚Ä¶</div>
            <div id="visitsError" class="admin-error" style="display: none;"></div>
            <div id="visitsTableWrapper" class="admin-table-wrapper" style="display: none;">
                <table class="admin-table" aria-label="Recent visits">
                    <thead>
                        <tr>
                            <th>Time (IST)</th>
                            <th>Session</th>
                            <th>User-Agent</th>
                            <th>Referrer</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="admin-card">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <h2><i class="fas fa-thumbs-up"></i> Feedback (Reactions)</h2>
                <button type="button" class="btn-refresh" id="refreshFeedback" aria-label="Refresh feedback"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            <p class="meta">Like / dislike on bot messages.</p>
            <div id="feedbackLoading" class="admin-loading">Loading feedback‚Ä¶</div>
            <div id="feedbackError" class="admin-error" style="display: none;"></div>
            <div id="feedbackTableWrapper" class="admin-table-wrapper" style="display: none;">
                <table class="admin-table" aria-label="Feedback">
                    <thead>
                        <tr>
                            <th>Time (IST)</th>
                            <th>Session</th>
                            <th>Message</th>
                            <th>Reaction</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        window.INITIAL_VISITS = {{ visits | tojson }};
        window.INITIAL_FEEDBACK = {{ feedback | tojson }};
        window.API_BASE = {{ (api_base or '') | tojson }};
    </script>
    <script>
        (function() {
            const adminKey = new URLSearchParams(window.location.search).get('key') || '';
            const base = (typeof window.API_BASE === 'string' && window.API_BASE) ? window.API_BASE : (function() {
                const p = window.location.pathname || '';
                return p.replace(/\/admin\/?$/, '') || '';
            })();
            const api = (path, qs) => base + path + (qs ? '?' + qs : '');

            function formatDate(iso) {
                if (!iso) return '‚Äî';
                try {
                    const d = new Date(iso);
                    return d.toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short', hour12: false });
                } catch (_) { return iso; }
            }
            function parseAsUTC(iso) {
                if (!iso) return null;
                const s = String(iso).trim();
                if (!s) return null;
                if (/Z$|[+-]\d{2}:?\d{2}$/.test(s)) return new Date(s);
                return new Date(s + (s.includes('.') ? 'Z' : '.000Z'));
            }
            function formatDateIST(iso) {
                try {
                    const d = parseAsUTC(iso);
                    if (!d || isNaN(d.getTime())) return '‚Äî';
                    return d.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'short', timeStyle: 'short', hour12: false });
                } catch (_) { return iso || '‚Äî'; }
            }

            function shortenSession(sid) {
                return sid ? (sid.length > 12 ? sid.slice(0, 8) + '‚Ä¶' : sid) : '‚Äî';
            }

            async function fetchJson(url) {
                const r = await fetch(url);
                const ct = (r.headers.get('Content-Type') || '').toLowerCase();
                const text = await r.text();
                if (!ct.includes('application/json')) {
                    throw new Error('Server returned a page instead of data. Open the admin at the same origin as the app (e.g. ' + window.location.origin + base + '/admin).');
                }
                let data;
                try {
                    data = JSON.parse(text);
                } catch (_) {
                    throw new Error('Invalid response from server.');
                }
                if (!r.ok) throw new Error(data.error || 'Request failed');
                return data;
            }

            function renderVisits(visits) {
                const body = document.getElementById('visitsTableBody');
                const wrap = document.getElementById('visitsTableWrapper');
                if (!visits || !visits.length) {
                    body.innerHTML = '<tr><td colspan="4">No visits yet.</td></tr>';
                } else {
                    body.innerHTML = visits.map(v => `
                        <tr>
                            <td class="date">${formatDateIST(v.visited_at)}</td>
                            <td class="session-id" title="${(v.session_id || '').replace(/"/g, '&quot;')}">${shortenSession(v.session_id)}</td>
                            <td class="user-agent" title="${(v.user_agent || '').replace(/"/g, '&quot;')}">${(v.user_agent || '‚Äî').slice(0, 60)}${(v.user_agent && v.user_agent.length > 60 ? '‚Ä¶' : '')}</td>
                            <td class="date">${v.referrer ? (v.referrer.length > 40 ? v.referrer.slice(0, 40) + '‚Ä¶' : v.referrer) : '‚Äî'}</td>
                        </tr>
                    `).join('');
                }
                wrap.style.display = 'block';
            }

            async function loadVisits(fromFetch) {
                const loading = document.getElementById('visitsLoading');
                const errEl = document.getElementById('visitsError');
                const wrap = document.getElementById('visitsTableWrapper');
                const body = document.getElementById('visitsTableBody');
                if (fromFetch) {
                    loading.style.display = 'block';
                    errEl.style.display = 'none';
                    wrap.style.display = 'none';
                }
                try {
                    if (!fromFetch && Array.isArray(window.INITIAL_VISITS)) {
                        loading.style.display = 'none';
                        renderVisits(window.INITIAL_VISITS);
                        return;
                    }
                    const qs = adminKey ? 'key=' + encodeURIComponent(adminKey) + '&limit=200' : 'limit=200';
                    const data = await fetchJson(api('/api/visits', qs));
                    loading.style.display = 'none';
                    renderVisits(data.visits || []);
                    if (data.total_visits != null) document.getElementById('statTotalVisits').textContent = data.total_visits;
                    if (data.unique_visitors != null) document.getElementById('statUniqueVisitors').textContent = data.unique_visitors;
                } catch (e) {
                    loading.style.display = 'none';
                    errEl.textContent = e.message || 'Error loading visits';
                    errEl.style.display = 'block';
                }
            }

            function renderFeedback(feedback) {
                const body = document.getElementById('feedbackTableBody');
                const wrap = document.getElementById('feedbackTableWrapper');
                if (!feedback || !feedback.length) {
                    body.innerHTML = '<tr><td colspan="4">No feedback yet.</td></tr>';
                } else {
                    body.innerHTML = feedback.map(f => {
                        const msg = (f.message_content || '').trim().replace(/</g, '&lt;').replace(/"/g, '&quot;');
                        const preview = msg ? (msg.slice(0, 80) + (msg.length > 80 ? '‚Ä¶' : '')) : '‚Äî';
                        return `
                        <tr>
                            <td class="date">${formatDateIST(f.timestamp)}</td>
                            <td class="session-id" title="${(f.session_id || '').replace(/"/g, '&quot;')}">${shortenSession(f.session_id)}</td>
                            <td class="message-preview" title="${msg || '‚Äî'}">${preview}</td>
                            <td><span class="reaction-${f.reaction === 'like' ? 'like' : 'dislike'}">${f.reaction === 'like' ? 'üëç Like' : 'üëé Dislike'}</span></td>
                        </tr>
                    `;
                    }).join('');
                }
                wrap.style.display = 'block';
            }

            async function loadFeedback(fromFetch) {
                const loading = document.getElementById('feedbackLoading');
                const errEl = document.getElementById('feedbackError');
                const wrap = document.getElementById('feedbackTableWrapper');
                const body = document.getElementById('feedbackTableBody');
                if (fromFetch) {
                    loading.style.display = 'block';
                    errEl.style.display = 'none';
                    wrap.style.display = 'none';
                }
                try {
                    if (!fromFetch && Array.isArray(window.INITIAL_FEEDBACK)) {
                        loading.style.display = 'none';
                        renderFeedback(window.INITIAL_FEEDBACK);
                        return;
                    }
                    const qs = adminKey ? 'key=' + encodeURIComponent(adminKey) + '&limit=200' : 'limit=200';
                    const data = await fetchJson(api('/api/feedback', qs));
                    loading.style.display = 'none';
                    renderFeedback(data.feedback || []);
                } catch (e) {
                    loading.style.display = 'none';
                    errEl.textContent = e.message || 'Error loading feedback';
                    errEl.style.display = 'block';
                }
            }

            document.getElementById('refreshVisits').addEventListener('click', () => loadVisits(true));
            document.getElementById('refreshFeedback').addEventListener('click', () => loadFeedback(true));
            loadVisits(false);
            loadFeedback(false);
        })();
    </script>
</body>
</html>
